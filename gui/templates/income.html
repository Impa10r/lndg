{% extends "base.html" %}
{% load static %}
{% block title %} {{ block.super }} - P&L{% endblock %}
{% block content %}
<script src="{% static 'charts.js' %}"></script>
{% load humanize %}
<div class="w3-container w3-padding-small">
  <h2>P&L Statement For <a href="{{ graph_links }}/{{ network }}node/{{ node_info.identity_pubkey }}" target="_blank">{% if node_info.alias != "" %}{{ node_info.alias }}</a> ({{ node_info.identity_pubkey }}){% else %}{{ node_info.identity_pubkey }}</a>{% endif %}</h2>
  <canvas id="balances"></canvas>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const data = {
        datasets: [
          {
            label: 'Balance',
            yAxisID: 'y',
            fill: true,
            pointHoverRadius: 10,
            backgroundColor: 'rgba(251, 192, 147, 0.2)',
            borderColor: 'rgba(251, 192, 147, 0.5)',
            cubicInterpolationMode: 'monotone',
          },
          {
            label: 'On chain',
            fill: true,
            pointHoverRadius: 10,
            borderColor: 'rgba(255,119,0,1)',
            backgroundColor: 'rgba(255,119,0,0.1)',
            cubicInterpolationMode: 'monotone',
          },
          {
            label: 'Off chain',
            fill: true,
            pointHoverRadius: 10,
            borderColor: 'rgba(33,150,243)',
            backgroundColor: 'rgba(33,150,243,.2)',
            cubicInterpolationMode: 'monotone',
          },
          {
            label: 'Costs',
            yAxisID: 'y1',
            fill: true,
            pointHoverRadius: 10,
            borderColor: 'rgba(248,81,73)',
            backgroundColor: 'rgba(248,81,73,0.15)',
            cubicInterpolationMode: 'monotone',
          }
        ]
      };

      data.labels = [0]
      data.datasets.forEach(ds => ds.data = [0])
      const response = await GET('chart', {data: {} })

      const chart = new Chart(document.getElementById('balances'), {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Profitablity Overview'
            },
          },
          interaction: {
            mode: 'index',
            intersect: false
          },
          scales: {
            x: {
              display: true
            },
            y: {
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'sats'
              }
            },
            y1: {
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Cost'
              },
              // grid line settings
              grid: {
                drawOnChartArea: false, // only want the grid lines for one axis to show up
              },
            },
          }
        },
      })
      for(balance of response){
        data.labels.push(adjustTZ(balance.dt).toLocaleDateString())  
        data.datasets[1].data.push(balance.onchain + data.datasets[1].data.at(-1))
        data.datasets[3].data.push(parseInt(balance.cost + data.datasets[3].data.at(-1)))
        data.datasets[0].data.push(parseInt(balance.total + data.datasets[0].data.at(-1)))
        data.datasets[2].data.push(parseInt(balance.offchain + data.datasets[2].data.at(-1)))
      }

      function applyThemeToGrid(){
        if (document.body.classList.contains("dark-mode")) {
          chart.options.scales.x.grid.color = chart.options.scales.y.grid.color = 'rgba(255,255,255,0.1)'
        } else {
          chart.options.scales.x.grid.color = chart.options.scales.y.grid.color = 'rgba(0,0,0,0.1)'
        }

        chart.update();
      }
      applyThemeToGrid()
      byId('toggleTheme').addEventListener('click', applyThemeToGrid) 
    })
  </script>
  <hr/>
  <br/>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Line Item</th>
      <th>1 Day</th>
      <th>7 Day</th>
      <th>30 Day</th>
      <th>90 Day</th>
      <th>Lifetime</th>
    </tr>
    <tr>
      <td>Payments Routed</td>
      <td>{{ forward_count_1day|intcomma }}</td>
      <td>{{ forward_count_7day|intcomma }}</td>
      <td>{{ forward_count_30day|intcomma }}</td>
      <td>{{ forward_count_90day|intcomma }}</td>
      <td>{{ forward_count|intcomma }}</td>
    </tr>
    <tr>
      <td>Value Routed</td>
      <td>{{ forward_amount_1day|intcomma }}</td>
      <td>{{ forward_amount_7day|intcomma }}</td>
      <td>{{ forward_amount_30day|intcomma }}</td>
      <td>{{ forward_amount_90day|intcomma }}</td>
      <td>{{ forward_amount|intcomma }}</td>
    </tr>
    <tr>
      <td>Revenue Earned</td>
      <td>{{ total_revenue_1day|intcomma }} [{{ total_revenue_ppm_1day|intcomma }}]</td>
      <td>{{ total_revenue_7day|intcomma }} [{{ total_revenue_ppm_7day|intcomma }}]</td>
      <td>{{ total_revenue_30day|intcomma }} [{{ total_revenue_ppm_30day|intcomma }}]</td>
      <td>{{ total_revenue_90day|intcomma }} [{{ total_revenue_ppm_90day|intcomma }}]</td>
      <td>{{ total_revenue|intcomma }} [{{ total_revenue_ppm|intcomma }}]</td>
    </tr>
    <tr>
      <td>Onchain Costs</td>
      <td>{{ onchain_costs_1day|intcomma }}</td>
      <td>{{ onchain_costs_7day|intcomma }}</td>
      <td>{{ onchain_costs_30day|intcomma }}</td>
      <td>{{ onchain_costs_90day|intcomma }}</td>
      <td>{{ onchain_costs|intcomma }}</td>
    </tr>
    <tr>
      <td>Offchain Costs</td>
      <td>{{ total_fees_1day|intcomma }} [{{ total_fees_ppm_1day }}]</td>
      <td>{{ total_fees_7day|intcomma }} [{{ total_fees_ppm_7day }}]</td>
      <td>{{ total_fees_30day|intcomma }} [{{ total_fees_ppm_30day }}]</td>
      <td>{{ total_fees_90day|intcomma }} [{{ total_fees_ppm_90day }}]</td>
      <td>{{ total_fees|intcomma }} [{{ total_fees_ppm }}]</td>
    </tr>
    <tr>
      <td>Percent Cost</td>
      <td>{{ percent_cost_1day|intcomma }}%</td>
      <td>{{ percent_cost_7day|intcomma }}%</td>
      <td>{{ percent_cost_30day|intcomma }}%</td>
      <td>{{ percent_cost_90day|intcomma }}%</td>
      <td>{{ percent_cost|intcomma }}%</td>
    </tr>
    <tr>
      <td>Profits</td>
      <td>{{ profits_1day|intcomma }} [{{ profits_ppm_1day }}]</td>
      <td>{{ profits_7day|intcomma }} [{{ profits_ppm_7day }}]</td>
      <td>{{ profits_30day|intcomma }} [{{ profits_ppm_30day }}]</td>
      <td>{{ profits_90day|intcomma }} [{{ profits_ppm_90day }}]</td>
      <td>{{ profits|intcomma }} [{{ profits_ppm }}]</td>
    </tr>
  </table>
</div>
{% endblock %}